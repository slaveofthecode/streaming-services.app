---
import BaseLayout from '../layouts/BaseLayout.astro';
import Badge from '../components/Badge.astro';
import { Client } from '../types';

let clients = [];
let error = '';
let loading = true;

try {
  const response = await fetch('http://localhost:3001/api/clients');
  if (response.ok) {
    clients = await response.json();
  } else {
    error = 'Error al cargar clientes';
  }
} catch (e) {
  error = 'No se pudo conectar con el servidor';
  console.error(error, e);
} finally {
  loading = false;
}
---

<BaseLayout title="Clientes">
  <div class="mb-8 flex justify-between items-center">
    <h2 class="text-2xl font-bold">Clientes</h2>
    <button class="btn btn-primary" id="btn-add-client">
      + Nuevo Cliente
    </button>
  </div>

  {error && (
    <div class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
      {error}
    </div>
  )}

  {loading ? (
    <div class="text-center py-8">
      <p class="text-gray-600">Cargando clientes...</p>
    </div>
  ) : clients.length === 0 ? (
    <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
      <p class="text-gray-600 mb-4">No hay clientes registrados</p>
      <button class="btn btn-primary" id="btn-add-client-empty">
        Registrar Primer Cliente
      </button>
    </div>
  ) : (
    <div class="overflow-x-auto card">
      <table class="w-full">
        <thead>
          <tr class="border-b-2 border-gray-300">
            <th class="text-left py-3 px-4 font-semibold">Nombre</th>
            <th class="text-left py-3 px-4 font-semibold">Email</th>
            <th class="text-left py-3 px-4 font-semibold">Teléfono</th>
            <th class="text-left py-3 px-4 font-semibold">Estado</th>
            <th class="text-left py-3 px-4 font-semibold">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {clients.map((client) => (
            <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
              <td class="py-3 px-4 font-medium">{client.name}</td>
              <td class="py-3 px-4 text-gray-600">{client.email}</td>
              <td class="py-3 px-4 text-gray-600">{client.phone || '-'}</td>
              <td class="py-3 px-4">
                <Badge
                  text={client.isActive ? 'Activo' : 'Inactivo'}
                  type={client.isActive ? 'success' : 'error'}
                />
              </td>
              <td class="py-3 px-4 flex gap-2">
                <a
                  href={`/clientes/${client.id}`}
                  class="btn btn-outline text-sm px-3 py-1"
                >
                  Ver
                </a>
                <button
                  class="btn btn-outline text-sm px-3 py-1"
                  data-client-id={client.id}
                  id={`edit-client-${client.id}`}
                >
                  Editar
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )}

  <!-- Modal para añadir/editar cliente -->
  <div id="client-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="border-b border-gray-200 px-6 py-4">
        <h2 class="text-xl font-bold" id="modal-title">Nuevo Cliente</h2>
      </div>
      <form id="client-form" class="px-6 py-4 space-y-4">
        <div>
          <label class="label">Nombre Completo</label>
          <input
            type="text"
            id="client-name"
            class="input"
            placeholder="Juan Pérez"
            required
          />
        </div>
        <div>
          <label class="label">Email</label>
          <input
            type="email"
            id="client-email"
            class="input"
            placeholder="juan@example.com"
            required
          />
        </div>
        <div>
          <label class="label">Teléfono (Opcional)</label>
          <input
            type="tel"
            id="client-phone"
            class="input"
            placeholder="+34 600 123 456"
          />
        </div>
        <div>
          <label class="label">Dirección (Opcional)</label>
          <textarea
            id="client-address"
            class="input"
            placeholder="Calle Principal 123"
            rows="2"></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" class="btn btn-outline flex-1" id="btn-cancel">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary flex-1">
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const modal = document.getElementById('client-modal');
    const form = document.getElementById('client-form') as HTMLFormElement;
    const btnAdd = document.getElementById('btn-add-client');
    const btnAddEmpty = document.getElementById('btn-add-client-empty');
    const btnCancel = document.getElementById('btn-cancel');

    function openModal(title) {
      const modalTitle = document.getElementById('modal-title');
      if (modalTitle) modalTitle.textContent = title;
      form.reset();
      modal?.classList.remove('hidden');
    }

    function closeModal() {
      modal?.classList.add('hidden');
    }

    btnAdd?.addEventListener('click', () => openModal('Nuevo Cliente'));
    btnAddEmpty?.addEventListener('click', () => openModal('Nuevo Cliente'));
    btnCancel?.addEventListener('click', closeModal);

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        name: (document.getElementById('client-name') as HTMLInputElement).value,
        email: (document.getElementById('client-email') as HTMLInputElement)
          .value,
        phone: (document.getElementById('client-phone') as HTMLInputElement)
          .value || undefined,
        address: (document.getElementById('client-address') as HTMLTextAreaElement)
          .value || undefined,
      };

      try {
        const response = await fetch('http://localhost:3001/api/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          closeModal();
          location.reload();
        } else {
          alert('Error al crear cliente');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });
  </script>
</BaseLayout>
